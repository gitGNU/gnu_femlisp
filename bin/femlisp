#!/bin/sh
#PBS -l nodes=1:ppn=2,mem=2gb

if test -z "$FEMLISP_CL"; then
    FEMLISP_CL=/usr/local/bin/sbcl
fi

if test -z "$FEMLISP_CL_TYPE"; then
    FEMLISP_CL_TYPE=sbcl
fi

if test -z "$FEMLISP_DIR"; then
    FEMLISP_DIR=/home/neuss/CL-HOME/femlisp
fi

FEMLISP_CORE=$FEMLISP_DIR/bin/femlisp-$FEMLISP_CL_TYPE.core;

case $FEMLISP_CL_TYPE in
    acl) core="-I"; eval="-e"; noinit="-qq";;
    cmucl) core="-core"; load="-load"; eval="-eval"; noinit="-nositeinit -noinit";;
    sbcl) core="--core"; load="--load"; eval="--eval"; noinit="--sysinit /dev/null --userinit /dev/null";;
    *) echo "Unknown Common Lisp in FEMLISP_CL_TYPE"; exit 1;;
esac

if test "$1" = "--save-core-and-die"; then
    cd $FEMLISP_DIR/bin
    rm -f $FEMLISP_CORE
    sh ./femlisp $eval "(fl.port:save-femlisp-core-and-die \"$FEMLISP_CORE\")"
    if test -e $FEMLISP_CORE
	then
	echo "Built core in $FEMLISP_CORE"
	exit 0
	else
	echo "Not succeeded building core file"
	exit -1
    fi
fi

if test -f $FEMLISP_CORE; then
    exec $FEMLISP_CL $core $FEMLISP_CORE $eval "(fl.port:femlisp-restart)" "$@"
else
    exec $FEMLISP_CL $eval "(progn (load \"$FEMLISP_DIR/start.lisp\") (in-package :fl.application))" "$@"
fi