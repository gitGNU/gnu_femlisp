#!/bin/bash
#PBS -l nodes=1:ppn=2,mem=2gb

if test -z "$FEMLISP_CL"; then
    FEMLISP_CL=/usr/local/bin/sbcl
fi

if test -z "$FEMLISP_CL_TYPE"; then
    FEMLISP_CL_TYPE=sbcl
fi

if test -z "$FEMLISP_DIR"; then
    FEMLISP_DIR=/home/neuss/CL-HOME/femlisp
fi

case $FEMLISP_CL_TYPE in
    acl) core="-I"; load="-L"; eval="-e"; noinit="-qq";;
    cmucl) core="-core"; load="-load"; eval="-eval"; noinit="-nositeinit -noinit";;
    sbcl) core="--core"; load="--load"; eval="--eval"; noinit="--sysinit /dev/null --userinit /dev/null";;
    ecl) core=""; load="-load"; eval="-eval"; noinit="-norc";;
    gcl) core=""; load="-load"; eval="-eval";;
    *) echo "Unknown Common Lisp in FEMLISP_CL_TYPE"; exit 1;;
esac

cd $FEMLISP_DIR
FEMLISP_CORE=bin/femlisp-$FEMLISP_CL_TYPE.core;
if test "$1" = "--save-core-and-die"; then
    rm -f $FEMLISP_CORE
    # the following passing of a keyword is a kludge due to a bug in Allegro
    bash ./bin/femlisp $eval "(fl.port:save-femlisp-core-and-die :$FEMLISP_CORE)"
    if test -f $FEMLISP_CORE
	then
	echo "Built core in $FEMLISP_CORE"
	else
	echo "Building core file was not successful"
    fi
    exit 0
fi

case $FEMLISP_CL_TYPE in
    ecl) corecall="";;
    gcl) corecall="";;
    *) corecall="$FEMLISP_CL $core";;
esac

if test -f $FEMLISP_CORE; then
    exec $corecall $FEMLISP_CORE $eval "(fl.port:femlisp-restart)" "$@"
else
    exec $FEMLISP_CL $load start.lisp $eval "(in-package :fl.application)" "$@"
fi
